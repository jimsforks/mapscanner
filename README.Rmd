---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```
# mapscanner ![](http://www.textfiles.com/underconstruction/CoColosseumHoop5020underconstruction_blk.gif)

<!-- badges: start -->
[![Travis build status](https://travis-ci.org/mpadge/mapscanner.svg?branch=master)](https://travis-ci.org/mpadge/mapscanner)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/mpadge/mapscanner?branch=master&svg=true)](https://ci.appveyor.com/project/mpadge/mapscanner)
[![codecov](https://codecov.io/gh/mpadge/mapscanner/branch/master/graph/badge.svg)](https://codecov.io/gh/mpadge/mapscanner)
[![Project Status: Concept](https://www.repostatus.org/badges/latest/concept.svg)](https://www.repostatus.org/#concept)
<!-- badges: end -->

R package to print maps, draw on them, scan them back in, and convert to
spatial objects. Currently [under review at
rOpenSci](https://github.com/ropensci/software-review/issues/330#event-2513283441).


## installation

`mapscanner` is not (yet) on CRAN. The development version can be installed with
```{r install, eval = FALSE}
remote::install_github("mpadge/mapscanner")
```
The package can then be loaded for usage in a R session with
```{r library}
library (mapscanner)
```

## usage


Package comes with a sample map of Omaha, Nebraska, USA, and one with some red
lines drawn on it:
![](./man/figures/omaha-polygons.png)

That's just a standard `png` image with no notion of geographical coordinates.
The original map was generated with

```{r omaha-fakey, eval = FALSE}
bbox <- rbind (c (-96.12923, -96.01011),
               c (41.26145, 41.32220)) # portion of omaha
ms_generate_map (bbox, max_tiles = 16L, mapname = "omaha")
```
```{r omaha, echo = FALSE}
bbox <- rbind (c (-96.12923, -96.01011),
               c (41.26145, 41.32220))
message ("Successfully generated 'omaha.pdf' and 'omaha.png'")
```
As indicated, the function generates a map in both `.pdf` and `.png` formats.
These files must be retained as the "master" maps against which subsequently
modified -- drawn-over and scanned-in -- versions will be rectified. The `.pdf`
format is generated because it will generally be the most convenient for
printing, while the rectification itself requires `.png`-format images. The
magic happens via the [`RNiftyReg`
package](https://github.com/jonclayden/RNiftyReg), itself primarily intended to
align brain scans and other medical images, but which is precisely the tool
needed here.

The `mapscanner` package comes with two sample `.png` images which can be used
to demonstrate functionality. In the following code, `f_modified` is the image
shown above, modified from the original by drawing a red line around a
particular region of Omaha.
```{r scan_maps}
f_orig <- system.file ("extdata", "omaha.png", package = "mapscanner")
f_mod <- system.file ("extdata", "omaha-polygons.png", package = "mapscanner")
system.time (res <- ms_rectify_maps (f_orig, f_mod, type = "polygons"))
res
```
The rectification can take quite some time, during which [`RNiftyReg`
package](https://github.com/jonclayden/RNiftyReg) is constructing the best
transformation of the modified image back on to the original. The result of
`ms_rectify_maps()` is a spatial object in
[`sf`](https://cran.r-project.org/package=sf)-format in which each drawn
component is represented as a separate polygon. Finally, we can plot the result
as an interactive map using packages like
[`mapdeck`](https://github.com/symbolixAU/mapdeck), or
[`mapview`](https://github.com/r-spatial/mapview):

```{r leaflet, echo = FALSE, eval = FALSE}
library(leaflet)

leaflet (res) %>%
    addPolygons (color = "#FF1111", weight = 1, opacity = 1.0,
                 fillOpacity = 0.5) %>%
    addProviderTiles ("CartoDB.Positron") %>%
    setView (lng = mean (bbox [1, ]),
             lat = mean (bbox [2, ]),
             zoom = 12)
```

![](./man/figures/leaflet-1.png)

And our hand-drawn lines shown above have been converted to standard spatial
objects able to be analysed in any desired way. See the [package
vignette](https://mpadge.github.io/mapscanner/articles/mapscanner.html) for
more detail of what the `mapscanner` package can do.


